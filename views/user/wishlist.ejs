<%- include("../../views/partials/user/header") %>

<!-- Start Banner Area -->
<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Wishlist</h1>
                <nav class="d-flex align-items-center">
                    <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                    <a href="/wishlist">Wishlist</a>
                </nav>
            </div>
        </div>
    </div>
</section>
<!-- End Banner Area -->

<main class="ps-main">
    <div class="ps-content pt-80 pb-80">
        <div class="ps-container">
            <div class="ps-cart-listing ps-table--whishlist">
                <table class="table ps-cart__table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Add to Cart</th>
                            <th>Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (wishlist && wishlist.length > 0) { %>
                            <% for (let product of wishlist) { %>
                                <tr>
                                    <td>
                                        <a class="ps-product__preview" href="/productDetails?id=<%= product._id %>">
                                            <img class="mr-15" src="<%= product.productImage[0] %>" alt="<%= product.productName %>">
                                        </a>
                                    </td>
                                    <td>
                                        <a class="ps-product__preview" href="/productDetails?id=<%= product._id %>">
                                            <%= product.productName %>
                                        </a>
                                        <p class="font-xs">
                                            <%= product.category.name %><br>
                                            <%= product.brand %>
                                        </p>
                                    </td>
                                    <td>â‚¹<%= product.salePrice %></td>
                                    <td>
                                        <a href="#" onclick="addToCart('<%= product._id %>')" class="btn btn-sm">Add to Cart</a>
                                    </td>
                                    <td>
                                        <a href="#" onclick="confirmRemove('<%= product._id %>')" >
                                       

<style>
    .button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgb(20, 20, 20);
    border: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.164);
    cursor: pointer;
    transition-duration: .3s;
    overflow: hidden;
    position: relative;
  }
  
  .svgIcon {
    width: 12px;
    transition-duration: .3s;
  }
  
  .svgIcon path {
    fill: white;
  }
  
  .button:hover {
    width: 140px;
    border-radius: 50px;
    transition-duration: .3s;
    background-color: rgb(255, 69, 69);
    align-items: center;
  }
  
  .button:hover .svgIcon {
    width: 50px;
    transition-duration: .3s;
    transform: translateY(60%);
  }
  
  .button::before {
    position: absolute;
    top: -20px;
    content: "Delete";
    color: white;
    transition-duration: .3s;
    font-size: 2px;
  }
  
  .button:hover::before {
    font-size: 13px;
    opacity: 1;
    transform: translateY(30px);
    transition-duration: .3s;
  }
  </style>
  <button class="button">
    <svg viewBox="0 0 448 512" class="svgIcon"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path></svg>
  </button>
                                        </a>
                                    </td>
                                </tr>
                            <% } %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <p class="lead mb-4">No items found in Wishlist</p>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<%- include("../../views/partials/user/footer") %>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function confirmRemove(productId) {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, remove it!"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/removeFromWishList?productId=${productId}`;
            }
        });
    }

    // function addToCart(productId) {
    //     console.log('Adding product to cart:', productId); // Debug
    //     fetch('/addToCart', {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json'
    //         },
    //         body: JSON.stringify({ productId }) // Send productId in body
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.status) { // Check data.status for consistency with controller
    //             Swal.fire({
    //                 title: "Added!",
    //                 text: "Product added to cart successfully.",
    //                 icon: "success",
    //                 confirmButtonText: "OK"
    //             });
    //         } else {
    //             Swal.fire({
    //                 title: "Error!",
    //                 text: data.message || "Failed to add product to cart.",
    //                 icon: "error",
    //                 confirmButtonText: "OK"
    //             });
    //         }
    //     })
    //     .catch(error => {
    //         Swal.fire({
    //             title: "Error!",
    //             text: "An error occurred while adding to cart.",
    //             icon: "error",
    //             confirmButtonText: "OK"
    //         });
    //     });
    // }
    function addToCart(productId) {
    console.log('Adding product to cart:', productId);
    fetch('/addToCart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId })
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status) {
            // If added to cart successfully, now remove from wishlist
            const removeResponse = await fetch(`/removeFromWishList?productId=${productId}`, {
                method: 'GET'
            });

            if (removeResponse.ok) {
                Swal.fire({
                    title: "Added!",
                    text: "Product added to cart and removed from wishlist.",
                    icon: "success",
                    confirmButtonText: "OK"
                }).then(() => {
                    // Reload the page to update wishlist UI
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    title: "Warning",
                    text: "Product added to cart but failed to remove from wishlist.",
                    icon: "warning",
                    confirmButtonText: "OK"
                });
            }
        } else {
            Swal.fire({
                title: "Error!",
                text: data.message || "Failed to add product to cart.",
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .catch(error => {
        Swal.fire({
            title: "Error!",
            text: "An error occurred while adding to cart.",
            icon: "error",
            confirmButtonText: "OK"
        });
    });
}

</script>

<!-- CSS for styling (can be placed in a separate file or your existing stylesheet) -->
<style>
    .ps-main {
        background: #f9f9f9;
    }
    .ps-content {
        padding: 80px 0;
    }
    .ps-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    .ps-cart__table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .ps-cart__table th, .ps-cart__table td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #e5e5e5;
    }
    .ps-cart__table th {
        background: #f5f5f5;
        font-weight: 600;
    }
    .ps-product__preview {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #333;
    }
    .ps-product__preview img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        margin-right: 15px;
    }
    .btn.btn-sm {
        padding: 8px 15px;
        background: #50CF96;
        color: #fff;
        border-radius: 4px;
        text-decoration: none;
        font-size: 14px;
    }
    .btn.btn-sm:hover {
        background: #50CF96;
    }
    .ps-remove {
        display: inline-block;
        color: #dc3545;
        text-decoration: none;
    }
    .ps-remove:hover {
        color: #a71d2a;
    }
    .font-xs {
        font-size: 12px;
        color: #777;
    }
    .text-center {
        text-align: center;
    }
    .lead {
        font-size: 18px;
        color: #555;
    }
    .banner-area {
        background: url('/images/banner-bg.jpg') no-repeat center/cover;
        padding: 50px 0;
        color: #fff;
    }
    .breadcrumb-banner h1 {
        font-size: 36px;
        margin-bottom: 10px;
    }
    .breadcrumb-banner nav a {
        color: #fff;
        text-decoration: none;
    }
    .breadcrumb-banner nav a:hover {
        text-decoration: underline;
    }
    .lnr.lnr-arrow-right {
        margin: 0 10px;
    }
</style>